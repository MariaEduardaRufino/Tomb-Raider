<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="./assets/css/vote.css">
</head>

<body>
    <div class="navbar">
        <div>
            <a href="home.html"><img src="./assets/img/logo tr menu.png"></a>
        </div>

        <!-- <div class="menu">
            <button onclick="window.location.href = 'login.html'">Sign in</button>
            <button onclick="window.location.href = 'cadastro.html'" id="btn_principal">Sign up</button>
        </div> -->
    </div>
    <div class="contaner-geral">
        <div class="container-vote">
            <div class="box-vote">
                <img src="https://images6.alphacoders.com/423/thumb-1920-423181.jpg" alt="">
                <div class="vote">
                    <span>Votos Tomb Raider:</span>
                    <h1 id="voteTR"></h1>
                </div>
            </div>
            <div class="box-vote">
                <img src="https://assets.reedpopcdn.com/digitalfoundry-2016-rise-of-the-tomb-raider-pc-face-off-1453834812874.jpg/BROK/resize/1200x1200%3E/format/jpg/quality/70/digitalfoundry-2016-rise-of-the-tomb-raider-pc-face-off-1453834812874.jpg" alt="">
                <div class="vote">
                    <span>Votos Rise of Tomb Raider:</span>
                    <h1 id="voteTRRise"></h1>
                </div>
            </div>
            <div class="box-vote">
                <img src="https://preview.redd.it/hmwmn1e0oo871.png?width=640&crop=smart&auto=webp&s=f149ec2daa8c83741ff359e7494daaa9e83fe34b" alt="">
                <div class="vote">
                    <span>Votos Shadow of Tomb Raider:</span>
                    <h1 id="voteTRShadow"></h1>
                </div>
            </div>

        </div>
        <div class="container-conteudo">
            de qual você mais gostou?

            <select name="" id="slc_voto">

            </select><br>
            <div id="div_btnvotar">

                <button onclick="cadastrar_voto()">Votar</button>
            </div>
            <br><br>
            <div id="metrica"></div>

        </div>
    </div>

</body>

</html>
<script>
    var idUser = sessionStorage.ID_USUARIO
    var voto = []
    
    
    var verifyVoto = false

    mostrar_game()
    function mostrar_game() {
        fetch("/usuarios/mostrar_game", {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        })
            .then(function (response) {
                if (response.ok) {
                    response.json().then(function (resposta) {
                        listar_select(resposta)
                    })
                }
                else {
                    console.log("ERRO")
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados. Erro: ${error.message}`)
            })
    }

    function listar_select(dados) {
        if (!verifyVoto) {
            for (var i = 0; i < dados.length; i++) {
                var atual = dados[i]
                slc_voto.innerHTML += `<option value="${atual.idGame}">${atual.nomeGame}</option>`
            }
        } else {
            for (var i = 0; i < dados.length; i++) {
                var atual = dados[i]
                slc_voto.innerHTML += `<option value="${atual.idGame}" disabled>${atual.nomeGame}</option>`
            }
        }
    }
    // var votoList = []

    function cadastrar_voto() {
        var voto = slc_voto.value
        // votoList.push(voto)
        var id = sessionStorage.ID_USUARIO
        fetch("/usuarios/cadastrar_voto", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                // crie um atributo que recebe o valor recuperado aqui
                // Agora vá para o arquivo routes/usuario.js
                votoServer: voto,
                idServer: id
            })
        })
            .then(function (resposta) {

                console.log("resposta: ", resposta);

                if (resposta.ok) {
                    verifyVoto = true
                    blockVoto()

                    console.log(resposta)
                    alert('Voto realizado com sucesso')
                    window.location = "vote.html"
                } else {
                    throw ("Houve um erro ao tentar realizar o cadastro!");
                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);

            });
    }
    function blockVoto() {
        div_btnvotar.innerHTML = `<button style="background-color : rgb(80 80 80);" onclick="cadastrar_voto()" disabled>Votar</button><br>
        OBRIGADO POR VOTAR!!!`


    }

    mostrar_voto()
    function mostrar_voto() {
        fetch("/usuarios/voto", {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        })
            .then(function (response) {
                if (response.ok) {
                    response.json().then(function (resposta) {
                        console.log(resposta);
                        voto = resposta
                        verifyOneVoto()
                        console.log(voto);
                        listar_voto(resposta)
                    })
                }
                else {
                    console.log("ERRO345253")
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados. Erro: ${error.message}`)
            })
    }
    function listar_voto(dados) {
        var countRise = 0
        var countShadow = 0
        var countTomb = 0

        for (var i = 0; i < dados.length; i++) {
            var voto = dados[i]
            var game = ""
            if (voto.fkgame == 1) {
                countRise++
                game = "Rise of the Tomb Raider"
            } else if (voto.fkgame == 2) {
                countShadow++
                game = "Shadown of the Tomb Raider"
            } else if (voto.fkgame == 3) {
                countTomb++
                game = "Tomb Raider"
            }

        }

        voteTR.innerHTML =`${countTomb}`;
        voteTRShadow.innerHTML = `${countShadow}`;
        voteTRRise.innerHTML = `${countRise}`
       
    };

    verifyOneVoto()
    function verifyOneVoto(){
        console.log(idUser);
        console.log(voto);
        var searchVoto = voto.find(resp => resp.fkUser == idUser)
        console.log(searchVoto);
        if(searchVoto != null){
            verifyVoto = true
            blockVoto()
        }
        // console.log(searchVoto);
    }
</script>